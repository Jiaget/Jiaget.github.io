---
title: 浅析golang 闭包
date: 2021-06-03 12:26:10
tags: 
    - golang
    - 闭包
    - 计算机科学
categories: golang
---

# 0.函数

```
在 Golang 中，函数可以用作其他的函数入参，也能被当作返回值，还是能绑定到变量。

func A() {}
func B(f func()){}
func C() {
    return A
}
var f func() = C()
```

像上面这样的函数的三种角色（参数，返回值，变量）实际上是一个 `Function Value` 是一个指针，但是并不指向函数的执行入口。它会先指向一个结构体

```
type funcval struct {
    fn uintptr
}
```

这个结构体中的 `fn` 才会指向函数的执行入口。而这种二级指针的作用就是为了实现闭包。

# 1.什么是闭包

```
闭包包含自由变量（在函数外部定义，但在函数内被引用），闭包的自由变量在被捕捉时被确定，保证脱离了捕捉时的上下文也能照常运行。
    --- 摘自维基百科

```

举一个例子：

```
func create() func()int {
    c := 2
    return func() int {
        return c
    }
}

func main() {
    f1 := create()
    fmt.Println(f1{})
}
```

在 `create()` 中的返回值是一个闭包函数，这样的闭包函数，在编译阶段就已经生成完毕，而 c 这样的局部变量返回给了外部空间的 `捕获变量` 会和闭包函数一起在执行阶段被保存在闭包对象中并船舰。

局部变量 c 虽然在一开始被放在了 create() 函数栈中，但在堆上创建闭包对象时，它也被捕获在了堆上。

捕获对象中的 funcValue 指向了 `create()` 函数中的返回函数

# 2. 捕获变量的分配问题

- 当被捕获的变量在函数中没有被修改时，它只会将值拷贝在捕获列表中即可。
- 当捕获变量还被修改过。首先，捕获变量会被改成堆分配，在栈上只分配了一个地址。如果还存在一个闭包函数来获取这个变量，闭包对象中也同样获取这个变量的地址。这样 闭包函数和外部函数都可以操作这个变量。

