---
title: tpc 粘包
date: 2021-06-16 13:24:47
tags:
    - 计算机网络
    - tcp
categories: 网络
---

# 0. 背景

socket网络编程采用端对端通信，可以使用 [`源IP`, `源端口`， `目的IP`, `目的端口`, `传输层协议`] 这样的五元组来描述一个连接。发送者往往发送多个包给接收者，为了更高效地发送数据包，采用了优化算法（`Nagle` 算法）， 将`多次`，`间隔小`,`数据量小`的数据，合并成一个数据量大的数据块，然后进行封装包。同时, 接收者也需要使用高效的拆包机制来分辨这些数据

# 1.什么是TCP粘包

## 发送者

TCP默认使用 `Nagle`算法，用于减少网络中报文数量，其主要：

- 1. 只有当上一个分组得到确认后，才会发送下一个分组
- 2. 手机多个小分组，当确认到达后，一起发送

## 接收者

TPC接收到数据包后，不会马上交给应用层处理，而是将其缓存，而应用程序需要主动从缓存中接收分组。

在这种情况下，当满足以下条件，就会发生TCP `粘包`:
- TPC接收数据包到缓存的速度大于应用程序从缓存读取数据包的数据。
- 当多个包被缓存，应用程序有可能读取到多个首尾相接的包。

## 可能产生的问题

比如写的一段程序，向服务端发送两次数据，我希望服务端分别对这两个数据进行处理，但是服务器在一次接收时，将两条数据都读出来了。如果没有很好地处理这个场景，数据很容易被错误处理，甚至被认为时错误而被丢掉，导致服务端不能高效处理服务。

# 2.TCP粘包的谬误

实际上`TCP粘包`这个名词本身就不合理，因为：
- TCP本身就没有包的概念， 它是一个面向流的协议
- 而所谓的粘包是指，开发者在应用层封装的数据，开发者希望TCP能将这些数据自动拆分，然而TCP为了节省流量，会将包合并后发送。这并不是TCP的问题。

# 3. 解决思路

1. 格式化数据：给每条数据都设置固定的格式，（开始符， 结束符）。特点简单，但是要保证开始符结束符不会出现在数据内部。
2. 设置发送长度：发送数据时，将长度一并发送，这样应用层可以根据长度分辨数据的开始与结束

# 4. 总结

TCP 粘包本身就不是问题，但是通过这个“问题”可以学到一些非常基本的网络编程的规范。（应用开发者应该解决好自己定义的数据包分包的问题，而不是交给TCP解决）